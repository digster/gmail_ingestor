# 2026-02-25 — Label Names in DB + Frontmatter

## Changes Made

### Schema additions (`tracker.py`)
- `labels` table: `label_id` (PK), `label_name`, `updated_at` — synced from Gmail API
- `message_labels` table: `(message_id, label_id)` composite PK — junction table
- `upsert_labels()`: bulk upsert from `list_labels()` response using `ON CONFLICT DO UPDATE`
- `insert_message_labels()`: populate junction table with `INSERT OR IGNORE`
- `get_message_labels()`: LEFT JOIN returning `[{"id": ..., "name": ...}]`, falls back to label_id as name if no labels row

### Model changes (`models.py`)
- Added `label_ids: tuple[str, ...]` and `label_names: tuple[str, ...]` to `EmailHeader` with default empty tuples

### Frontmatter changes (`converter.py`)
- `_build_front_matter()` now appends `labels: [...]` and `label_ids: [...]` inline YAML lists when present
- Omitted when empty (same pattern as `cc:`)

### Pipeline wiring (`ingestor.py`)
- `_sync_labels()`: called at start of `run()`, fetches all Gmail labels and upserts
- Stage 2 (fetch): calls `tracker.insert_message_labels()` after parsing each message
- Stage 3 (convert): calls `tracker.get_message_labels()` and hydrates `EmailHeader` with label_ids/label_names

### Tests
- `TestLabelsTable`: 5 tests for table creation and upsert_labels
- `TestMessageLabels`: 6 tests for insert/get/duplicates/fallback/sorting/empty
- `TestLabelFrontMatter`: 3 tests for labels in frontmatter, omission when empty, quote escaping

### Docs
- Updated ARCHITECTURE.md with label storage section
- Updated README.md frontmatter example with labels
- Updated SKILL.md output format and SQLite description
